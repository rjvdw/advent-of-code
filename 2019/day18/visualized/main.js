'use strict'

const INPUT = `
#################################################################################
#.#m............#.........#.............#.........#..c..........P.#.....#...#...#
#.#.#####.#####.#.#.#######.#####.#.#####.###.###.#.#########.###.#.###.#.#.#.#.#
#.#.#.#...#g#...#.#.........#...#.#.#...#.#j..#.#.#.#..i..#...#...#b..#...#...#.#
#.#.#.#.###.#.###.#############.#.###.#.###.###.#.#.#.###.#.###.#####.#########.#
#.#...#...#.....#.....#.....#...#.....#.#...#...#.#.#...#.#...#.#.....#.......#.#
#.###.###.###########.#.###.#.#########N#.###.###.#####.#.###.#.###.###.###.###.#
#...#...#.....#.........#...#.......#...#.#.....#..h....#.....#.....#...#.#.....#
#.#.###.#####.#.###########.#####.#.#.#.#.#.###.#####################.###.#######
#.#...#...#.#.#...#.......#.....#.#.#.#.#.#v..#.....#.........#.#.....#.........#
#.#######.#.#.###.#.#####.#####.#.###.#.#.###.#####.#.###.###.#.#.#####.#######.#
#.#.......#.#.....#.....#...#.#...#...#.#.#.......#...#...#.....#.#.....#...#...#
#.#.#######.###########.###.#.###.#.###.#.#######.#####.#########.#.###.#.#.#####
#.#.....#...#.......#...#.#.#.....#...#.#.....#...#..e#...#.....#.#.#...#.#.#...#
#.#####.#.###.#####.#.###.#.#.#######.#######.#####.#.#.#.#.###.#.#.###.#O#.#.#.#
#.....#.#...#.#...#...#...#.#...#...#...#.Z...#...#.#.#.#.....#.#.#...#.#.#...#.#
#.#####.###.#.###.#####.#.#.###.###.###.#.#####.#.#Q#.#######.#.#.#.#.###.#####.#
#.#.....#...#.#...#.....#.#...#.....#...#....q..#...#.....#...#.#.#.#.....#...#.#
#.#.#####.###.#.#.###.#.#####.#######.#.#################.#.###.#.#########.#.#.#
#.#...#...#...#.#.#...#.#...#.#.....#.#.#x#....d....#...E.#...#..f#.......#.#...#
#.###.#.###.###.#.#.#####.#.#.#.###.#.#.#.#.#####.#.#.#####.###.###.#####.#.#####
#...#.#.#...#...#...#...#.#.#...#...#.#.#.#.....#.#.#s#.....#.#.#...#...#.#.....#
#.###.#.#.###.#.#######.#.#.#####.###.###.###.###.#.#.#######.#.#.###.###.#####.#
#.......#.#...#.#.......#.#.....#.#.....#...#.#...#.#.......S.#...#...#...#...#.#
#.#######.#.###.#.#######.#####.#.#####.#.###.#.###.###############.###.###.#.#.#
#.....#...#...#.#.........#...#...#...#.#.#...#.#.#...#...........#...#.#...#.#.#
#####.#.#######.###########.#.#####.#.#.#.#.###.#.#.###.#######.#.###.#.###.#.#.#
#.....#.#.....#...#...#.....#...#...#...#.#...#.#...#...#...#...#.....#...#.#...#
#.#####.#.###.#.#.###.#.#.###.###.#.#####.###.#.#####.###.#.#.#######.###.#.###.#
#...#...#.#.#.#.#...#...#.#...#...#.....#.....#.......#...#.#...#...#...#...#.#.#
###.#.###.#.#.#.###.#.###.#####.#######.#.#############.#.#####.#.#.#.#######.#.#
#...#.....#...#...#.#...#...#.........#.#...#.........#.#.#.....#.#...#.....#...#
#.#########.#####.#.#######.#.#######.#.###.#.#######.#.#.#.#.#####.###.###.#.###
#.#.......#...#...#.#.....#...#.....#.#.#...#...#.....#.#.#.#.#...#...#...#...#.#
#.#######.###.#.###.#.###.###.#.###.###.#.###.#.#.#####.###.#.#.#.#######.#####.#
#.#.K.....#.#...#.#...#.#...#.#.#...#...#.#...#.#...#.....#.#.#.#.........#.....#
#.#.#####.#.#####.#####.###.#.#.###.#.###.###.#.###.#####.#.###.###############.#
#...#...#.#.........#...#...#.#...#.#...#...#.#...#.......#.....#...#.....#...#t#
#####.###.#####.###.###.#.#######.#.###.###.#####.#######.#######.#.#.###.#.#.#.#
#...............#.......#.........#...............#...............#...#....u#...#
#######################################.@.#######################################
#.........#...#...#.#.....#...#.....#.........................#.....Y...#.......#
#.#.#####.#.#.#.#.#.#.#.#.#.#.#.###.#.#.#########.#########.###.#.#######.#####.#
#.#.#...#...#.#.#.#...#.#...#...#.#...#.#.......#.#.......#.#...#.#...#...#.....#
#.#.#.#.#####.#.#.###.#.#########.#####.#.#####.###.#####.#R#.###.#.#.#.###M###.#
#.#.#.#.....#...#...#.#.#...........#...#.#.#.......#.......#...#...#...#...#...#
#.#.#.#####.#######.###.#.###########.###.#.#.#################.#########.#####.#
#.#.#.#...#.#.....#.....#..........r#.#.#.#.....#.......#.....#.#.#.....#.#...#.#
#U#.#.###.#.#####.#######.#########.#.#.#.#######.#####.#.###.#.#.#.###.#.#.#.#.#
#.#.#.L.#.#.#.....#...#...#...#...#...#.#.#.......#...#.#...#.#.#...#...#.#.#.#.#
#.#.###.#.#.#.#####.#.#.###.#.#.#.#####.#.#.#######.###.###.#.#.#####.#.#.#.#.###
#.#...#...#.#.......#.#...#.#...#.......#...#.........#...#.#.#.#...W.#.#...#...#
#.#######.#.#########.###X#######.#####.#.#######.###.#.###.#.#.#.#############.#
#.......#.#.#.....#.....#.#.....#.#.....#.......#...#.#.....#..l#...#.....#...#.#
#.#####.#.#.#.###.#.#.###.#.###.#.###.#########.#####.###########.#.#.#.#.#.#.#.#
#...#.#...#...#.#.#.#.#.....#...#...#...#...#...#.....#...#.......#...#.#.#.#.#.#
###.#.#########.#.#D###.#####.###.#.###.#.#.#.###.###.###.#.#####.#####.#.#.#.#.#
#.#.#...........#.#.....#...#.#...#.#.#.#.#.#.....#.#...#...#...#.#.....#...#.#.#
#.#T###.#########.###.###.#.#.#####.#.#.###.#######.###.#####.#.#.#.#######.###.#
#.#...#.........#...#...#.#.#..n....#.#.#.............#...#...#.#.#.#.....#.#...#
#.###.#.#####.#.###.#####.#.###.#####.#.#.#########.#####.#.###.###.#.###.#.#.#.#
#.....#.#...#.#...#.#.#...#.#...#...#.#.#.#.....#...#...#.#.#.#.....#...#.#.#.#.#
#.#######.#.#.#.#.#.#.#.###.#####.#.#.#.#.###.#.#.###.#.#.#.#.###.#####.###.#.###
#...#.....#.#.#.#.#.#...#.#.#.....#.#...#...#.#...#...#.....#...#.#...#.....#...#
###.#.#####.###.#.#.#####.#.#.#####.#####.#.#######.###########.###.#I#######.#.#
#.#.#a..#.......#.#.......#...#...#.....#.#.........#.....#....z#...#.......#.#.#
#.#.###.#########.#.#####.#######.#####.#.###########.#.###.#####.#########.#.#.#
#.#...#.#...#...#.#.#...#...#.....#.....#.#...#.....#.#.#...#.....#.#.....#.#.#.#
#.###.#.#.#.###.#.#.#.#.###.#.#####.#####.#.#.#.###.#.#.#.###.#.###.#.###.#.#.#.#
#...#.#...#...#...#.#.#...#...#.....#...#.#.#...#...#.#.#.#...#.H.#.#...#.#.#.#.#
#.###.#######.#####.###.#.###G#.#######.#.#.#####.###.#.#J#######.#.###.#.#.###.#
#..y..#.....#.#...#...#.#.....#.........#.#...#...#...#.#.........#...#.#.C.#...#
#.#####.###.#.#.#.###.#.###############.#.###.#.###.###.###########.###.#####.#.#
#...#.....#.#...#...#.#.#...........#...#.....#.#.#...#.#...B.#..p#.....#.....#.#
###.#.###.#.#.#####.#.###.#####.#####.#########.#.#.#F#.#.#.#.###.#.#####.#####.#
#.#w#.#...#.#...#...#...#.....#.......#.#...#...#.#.#.#.#.#.#.....#.#.......#...#
#.#.###.###.#####.#####.#####.#########.#.#.#.###.#.#.###.#.#######.#.#####A#####
#.#.....#.#.....#.....#.#...#...#...#...#.#...#.....#...#.#.........#.....#....k#
#.#######.#####.#####.#.#.#.###.#.#.#.#.#.#############.#.#####################.#
#.....................#..o#.......#...#.#...............#...V...................#
#################################################################################
`.trim()

async function main() {
    const entrance = initialize_table()
    initialize_controls(entrance)
}

function initialize_table() {
    const keymap = {}
    const table = document.getElementById('dungeon-map')
    table.innerHTML = ''
    let x = 0;
    let y = 0;
    let entrance = [0, 0];
    for (const line of INPUT.split('\n')) {
        const tr = document.createElement('tr')
        table.append(tr)
        for (const ch of line.split('')) {
            const td = document.createElement('td')
            td.title = `(${ x }, ${ y })`
            tr.append(td)
            if (ch === '#') {
                td.classList.add('wall')
            } else if (ch === '@') {
                td.classList.add('entrance')
                entrance = [x, y]
            } else if (ch !== '.') {
                td.innerHTML = ch
                if (ch.toUpperCase() === ch) {
                    td.classList.add('door');
                } else {
                    td.classList.add('key');
                }
                const key = ch.toLowerCase()
                if (!keymap[key]) {
                    keymap[key] = []
                }
                keymap[key].push(td)
            }
            x += 1
        }
        x = 0
        y += 1
    }
    let highlighted = [];
    table.addEventListener('mouseout', event => {
        for (const cell of highlighted) {
            cell.classList.remove('highlighted')
        }
        highlighted = [];
    })
    table.addEventListener('mouseover', event => {
        const td = event.target
        if (td.tagName === 'TD') {
            if (td.classList.contains('door') || td.classList.contains('key')) {
                const key = td.innerHTML.toLowerCase()
                for (const cell of keymap[key]) {
                    cell.classList.add('highlighted')
                }
                highlighted = keymap[key]
            }
        }
    })
    return entrance
}

function initialize_controls(entrance) {
    const [x, y] = entrance
    const part1 = document.getElementById('part1')
    const part2 = document.getElementById('part2')

    const table = document.getElementById('dungeon-map')
    const at = (x, y) => table.children[y].children[x]

    part1.addEventListener('click', () => {
        part1.classList.add('active')
        part2.classList.remove('active')

        at(x, y).classList.add('entrance')
        at(x - 1, y - 1).classList.remove('entrance')
        at(x + 1, y - 1).classList.remove('entrance')
        at(x - 1, y + 1).classList.remove('entrance')
        at(x + 1, y + 1).classList.remove('entrance')

        at(x, y).classList.remove('wall')
        at(x - 1, y).classList.remove('wall')
        at(x + 1, y).classList.remove('wall')
        at(x, y - 1).classList.remove('wall')
        at(x, y + 1).classList.remove('wall')
    })

    part2.addEventListener('click', () => {
        part2.classList.add('active')
        part1.classList.remove('active')

        at(x, y).classList.remove('entrance')
        at(x - 1, y - 1).classList.add('entrance')
        at(x + 1, y - 1).classList.add('entrance')
        at(x - 1, y + 1).classList.add('entrance')
        at(x + 1, y + 1).classList.add('entrance')

        at(x, y).classList.add('wall')
        at(x - 1, y).classList.add('wall')
        at(x + 1, y).classList.add('wall')
        at(x, y - 1).classList.add('wall')
        at(x, y + 1).classList.add('wall')
    })
}

main().catch(err => console.error(err))
